{% extends "base.html" %}
{% block content %}

<div class="settings-container">
    <div class="settings-header">
        <h1>Configura√ß√µes</h1>
    </div>

    <div class="settings-grid">
        
        <div class="setting-card">
            <div class="card-header">
                <div class="icon-box purple">üéµ</div>
                <div class="header-text">
                    <h3>Deezer</h3>
                    <p>Credenciais de Acesso</p>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="/settings">
                    <input type="hidden" name="form_type" value="deezer">
                    <div class="form-group">
                        <label>ARL (Token)</label>
                        <input type="password" name="deezer_arl" value="{{ deezer_arl }}" class="input-text" placeholder="Cole seu ARL aqui...">
                    </div>

                    <div class="form-group">
                        <label>Qualidade</label>
                        <select name="download_quality" class="input-select">
                            <option value="1" {% if download_quality == '1' %}selected{% endif %}>MP3 128kbps (Free)</option>
                            <option value="3" {% if download_quality == '3' %}selected{% endif %}>MP3 320kbps (Premium)</option>
                            <option value="9" {% if download_quality == '9' %}selected{% endif %}>FLAC (HiFi)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-save">Salvar Credenciais</button>
                </form>
            </div>
        </div>

        <div class="setting-card">
            <div class="card-header">
                <div class="icon-box orange">‚öôÔ∏è</div>
                <div class="header-text">
                    <h3>Filtros</h3>
                    <p>Regras de Download</p>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="/settings">
                    <input type="hidden" name="form_type" value="filters">
                    <div class="form-group">
                        <label>Ignorar (separar por v√≠rgula)</label>
                        <input type="text" name="ignored_keywords" value="{{ ignored_keywords }}" class="input-text">
                    </div>
                    <div class="form-group">
                        <label>M√°x. Faixas por √Ålbum</label>
                        <input type="number" name="max_tracks" value="{{ max_tracks }}" class="input-text">
                    </div>
                    <button type="submit" class="btn-save">Salvar Filtros</button>
                </form>
            </div>
        </div>

        <div class="setting-card">
            <div class="card-header">
                <div class="icon-box red">üï∏Ô∏è</div>
                <div class="header-text">
                    <h3>Spider (Beta)</h3>
                    <p>Expans√£o Autom√°tica</p>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="/settings">
                    <input type="hidden" name="form_type" value="spider">
                    
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <input type="checkbox" id="spider_enabled" name="spider_enabled" value="true" 
                               style="width: 20px; height: 20px;" {% if spider_enabled == 'true' %}checked{% endif %}>
                        <label for="spider_enabled" style="margin:0; cursor: pointer;">Ativar Spider</label>
                    </div>

                    <div class="form-group">
                        <label>Crescimento Di√°rio (%)</label>
                        <input type="number" name="spider_growth" value="{{ spider_growth }}" class="input-text" placeholder="Ex: 10">
                        <small style="color: #666;">Quanto a biblioteca deve crescer baseado no tamanho atual.</small>
                    </div>

                    <div class="form-group">
                        <label>M√≠nimo de F√£s</label>
                        <input type="number" name="spider_min_fans" value="{{ spider_min_fans }}" class="input-text" placeholder="Ex: 5000">
                        <small style="color: #666;">Evita baixar artistas muito desconhecidos ou errados.</small>
                    </div>

                    <button type="submit" class="btn-save" style="background-color: #e74c3c; color: white;">Salvar Spider</button>
                </form>
            </div>
        </div>

        <div class="setting-card">
            <div class="card-header">
                <div class="icon-box yellow">üõ†Ô∏è</div>
                <div class="header-text">
                    <h3>Manuten√ß√£o</h3>
                    <p>Integridade da Biblioteca</p>
                </div>
            </div>
            <div class="card-body">
                <p style="color:#ccc; font-size:0.9rem; margin-bottom:15px;">
                    Verifica se existem faixas faltando nos √°lbuns j√° baixados (comparando com a API) e adiciona apenas as faltantes na fila.
                </p>
                <p style="color:#666; font-size:0.8rem; margin-bottom:15px;">Autom√°tico todo dia √†s 04:00.</p>
                
                <button onclick="triggerMaintenance()" class="btn-action" style="width:100%;">
                    üîß Verificar Integridade Agora
                </button>
            </div>
        </div>

        <div class="setting-card">
            <div class="card-header">
                <div class="icon-box green">üìö</div>
                <div class="header-text">
                    <h3>Importar</h3>
                    <p>Catalogar arquivos locais</p>
                </div>
            </div>
            <div class="card-body">
                <button onclick="startScan()" class="btn-action" style="width:100%; margin-bottom: 10px;">üîç Iniciar Scan</button>
                
                <div id="scanArea" style="display:none; background:#222; padding:10px; border-radius:8px;">
                    <div class="table-responsive">
                        <table class="import-table">
                            <thead>
                                <tr><th>Pasta</th><th>ID Detectado</th></tr>
                            </thead>
                            <tbody id="scanResultsBody"></tbody>
                        </table>
                    </div>
                    <button onclick="finalizeImport()" class="btn-save" style="margin-top:10px;">Confirmar</button>
                </div>
                <p style="color:#666; font-size:0.8rem; margin-top:10px;">Escaneia a pasta <code>/music</code> e vincula ao banco de dados sem baixar novamente.</p>
            </div>
        </div>

        <div class="setting-card system-card">
            <div class="card-header">
                <div class="icon-box blue">üöÄ</div>
                <div class="header-text">
                    <h3>Sobre Melodock</h3>
                    <p>Status do Sistema</p>
                </div>
            </div>
            <div class="card-body">
                <div class="version-display">
                    <span class="v-number">{{ system_version }}</span>
                    <div class="v-divider"></div>
                    <p class="v-text">{{ update_summary }}</p>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
let scannedData = [];
function startScan() {
    document.getElementById('scanArea').style.display = 'block';
    const tbody = document.getElementById('scanResultsBody');
    tbody.innerHTML = '<tr><td colspan="2">Escaneando...</td></tr>';
    
    fetch('/api/scan_library_preview').then(r=>r.json()).then(data => {
        scannedData = data;
        tbody.innerHTML = '';
        if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="2">Nada novo.</td></tr>'; return; }
        
        data.forEach((item, idx) => {
            let row = `
                <tr>
                    <td style="font-size:0.8rem; color:#fff;">${item.folder}</td>
                    <td>
                        <input type="text" class="input-id" value="${item.deezer_id || ''}" id="id-${idx}" placeholder="ID">
                    </td>
                </tr>`;
            tbody.innerHTML += row;
        });
    });
}

function finalizeImport() {
    const payload = scannedData.map((item, index) => {
        return {
            folder: item.folder,
            name: item.detected_name,
            deezer_id: document.getElementById(`id-${index}`).value
        };
    });
    if(!confirm("Iniciar importa√ß√£o?")) return;
    fetch('/api/import_library', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    }).then(() => { alert('Importa√ß√£o rodando em background!'); location.href='/logs'; });
}

function triggerMaintenance() {
    if(!confirm("Isso vai verificar todos os √°lbuns da biblioteca. Pode demorar. Continuar?")) return;
    fetch('/api/trigger_maintenance', { method:'POST' })
    .then(r => r.json())
    .then(d => { 
        alert(d.message); 
        location.href='/logs'; 
    });
}
</script>

<style>
    .settings-container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
    .setting-card { background: #1e1e1e; border-radius: 12px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; }
    .card-header { padding: 20px; background: rgba(255,255,255,0.03); border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; }
    .header-text h3 { margin: 0; font-size: 1.1rem; color: white; }
    .header-text p { margin: 2px 0 0 0; font-size: 0.85rem; color: #888; }
    .card-body { padding: 20px; flex-grow: 1; }
    
    .icon-box { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    .blue { background: rgba(41, 121, 255, 0.15); color: #2979ff; }
    .purple { background: rgba(187, 134, 252, 0.15); color: #bb86fc; }
    .orange { background: rgba(255, 152, 0, 0.15); color: #ff9800; }
    .green { background: rgba(29, 185, 84, 0.15); color: #1db954; }
    .red { background: rgba(231, 76, 60, 0.15); color: #e74c3c; } 
    .yellow { background: rgba(241, 196, 15, 0.15); color: #f1c40f; }

    .version-display { display: flex; align-items: center; gap: 20px; }
    .v-number { font-size: 1.8rem; font-weight: 800; color: #fff; letter-spacing: -1px; }
    .v-divider { width: 1px; height: 40px; background: #444; }
    .v-text { color: #ccc; font-size: 0.95rem; line-height: 1.4; margin: 0; }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; color: #ccc; font-weight: bold; font-size: 0.9rem; }
    .input-text, .input-select { width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
    .input-id { width: 100px; background: #121212; border: 1px solid #444; color: #1db954; padding: 5px; text-align: center; border-radius: 4px; }
    
    .btn-save { width: 100%; padding: 10px; background: #1db954; color: black; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-save:hover { filter: brightness(1.1); }
    .btn-action { padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: bold; }
    .btn-action:hover { background: #444; border-color: #777; }
    
    .import-table { width: 100%; margin-bottom: 10px; }
    .import-table th { text-align: left; padding: 8px; color: #888; font-size: 0.75rem; border-bottom: 1px solid #444; text-transform: uppercase; }
    .import-table td { padding: 8px; border-bottom: 1px solid #333; }
</style>
{% endblock %}