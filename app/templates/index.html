{% extends "base.html" %}
{% block content %}

<div class="search-page-container">
    
    <h1 class="main-logo">
        Melo<span style="color: #1db954;">dock</span>
    </h1>
    
    <div class="search-wrapper">
        <input type="text" id="artistInput" 
               placeholder="Digite o nome do artista..." 
               autocomplete="off" 
               class="search-input">
        
        <button class="search-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>

        <div id="suggestions" class="suggestions-box"></div>
    </div>
    
    <div class="search-help">
        As fotos ajudam a identificar o artista correto. Clique para adicionar.
    </div>

    <form id="addForm" action="/add_artist" method="POST" style="display:none;">
        <input type="hidden" name="chosen_id" id="chosen_id">
        <input type="hidden" name="artist_name" id="hidden_name">
    </form>

</div>

<style>
    /* LAYOUT BÁSICO */
    .search-page-container {
        min-height: 80vh; display: flex; flex-direction: column;
        align-items: center; justify-content: center; width: 100%;
        padding-bottom: 100px;
    }

    .main-logo {
        font-size: 5rem; font-weight: 800; margin-bottom: 40px;
        letter-spacing: -2px; color: white;
    }

    /* BARRA DE BUSCA */
    .search-wrapper {
        width: 100%; max-width: 600px; position: relative; z-index: 10;
    }

    .search-input {
        width: 100%; padding: 25px 60px 25px 30px;
        border-radius: 50px; border: 2px solid #333;
        background: #121212; color: white; font-size: 1.3rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5); outline: none;
        transition: all 0.3s ease; box-sizing: border-box;
    }

    .search-input:focus {
        border-color: #1db954; background: #181818;
        box-shadow: 0 10px 25px rgba(29, 185, 84, 0.15);
    }

    .search-btn {
        position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
        background: transparent; border: none; color: #666; cursor: default;
    }

    /* DROPDOWN DE SUGESTÕES */
    .suggestions-box {
        position: absolute; top: 100%; left: 20px; right: 20px;
        background: #1a1a1a; border: 1px solid #333; border-top: none;
        border-radius: 0 0 20px 20px; z-index: 100;
        display: none; overflow: hidden; margin-top: -10px; padding-top: 10px;
        box-shadow: 0 15px 30px rgba(0,0,0,0.8);
    }

    .suggestion-item {
        padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #252525;
        display: flex; align-items: center; gap: 15px; transition: background 0.2s;
    }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background: #252525; }

    /* ESTILO HÍBRIDO DE AVATAR */
    .avatar-wrapper {
        width: 50px; height: 50px; position: relative;
        flex-shrink: 0; /* Impede que amasse */
    }

    .artist-thumb {
        width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
        border: 2px solid #333; display: block;
    }

    .artist-initial-fallback {
        width: 100%; height: 100%; border-radius: 50%;
        background: linear-gradient(135deg, #333, #555);
        color: white; font-weight: 800; font-size: 1.2rem;
        display: flex; align-items: center; justify-content: center;
        border: 2px solid #444;
        position: absolute; top: 0; left: 0;
    }

    .search-help { margin-top: 30px; color: #555; font-size: 0.9rem; }
</style>

<script>
    const input = document.getElementById('artistInput');
    const suggestions = document.getElementById('suggestions');
    const form = document.getElementById('addForm');
    const hiddenId = document.getElementById('chosen_id');
    const hiddenName = document.getElementById('hidden_name');
    let timeout = null;

    input.addEventListener('input', function() {
        const query = this.value;
        clearTimeout(timeout);
        
        if (query.length < 2) {
            suggestions.style.display = 'none';
            return;
        }

        timeout = setTimeout(() => {
            fetch(`/api/search_live?q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.length > 0) {
                        suggestions.innerHTML = data.map(artist => {
                            const initial = artist.name.charAt(0).toUpperCase();
                            const safeName = artist.name.replace(/'/g, "\\'");
                            const hasImage = artist.image && artist.image.length > 0;
                            
                            // Lógica Híbrida:
                            // 1. Tenta por a imagem.
                            // 2. O evento 'onerror' esconde a imagem e mostra a letra se der erro.
                            return `
                            <div class="suggestion-item" onclick="selectArtist('${artist.id}', '${safeName}')">
                                
                                <div class="avatar-wrapper">
                                    <div class="artist-initial-fallback" style="display:none;">${initial}</div>
                                    
                                    <img src="${artist.image}" class="artist-thumb"
                                         onload="this.style.opacity=1"
                                         onerror="this.style.display='none'; this.previousElementSibling.style.display='flex'">
                                </div>

                                <div style="display: flex; flex-direction: column; text-align: left;">
                                    <span style="font-weight: bold; font-size: 1.1rem; color: #fff;">${artist.name}</span>
                                    <span style="font-size: 0.8rem; color: #888;">${artist.genre || 'Artista'}</span>
                                    <span style="font-size: 0.7rem; color: #444;">ID: ${artist.id}</span>
                                </div>
                            </div>
                        `}).join('');
                        suggestions.style.display = 'block';
                    } else {
                        suggestions.style.display = 'none';
                    }
                })
                .catch(err => console.error(err));
        }, 300); 
    });

    document.addEventListener('click', function(e) {
        if (!document.querySelector('.search-wrapper').contains(e.target)) {
            suggestions.style.display = 'none';
        }
    });

    window.selectArtist = function(id, name) {
        input.value = name;        
        hiddenId.value = id;       
        hiddenName.value = name;
        suggestions.style.display = 'none';
        input.style.borderColor = '#1db954';
        input.value = "Adicionando " + name + "...";
        form.submit();             
    }
</script>
{% endblock %}